name: Publish

# Triggered by pushing a version tag on main.
# Workflow: merge PR into main → git tag v0.2.0 && git push origin v0.2.0 → this runs.
# To restrict who can push tags: Settings → Rules → Tag protection → pattern: v*
on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: astral-sh/setup-uv@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv pip install -e ".[dev]"

      - name: Run tests
        run: uv run pytest -m "not integration" -q

  publish:
    name: Build and publish
    needs: test
    runs-on: ubuntu-latest

    # This environment must be configured in your repo settings
    # (Settings → Environments → pypi) and matched to a Trusted Publisher
    # entry on PyPI (pypi.org → Your account → Publishing → Add a new publisher).
    # No API token is needed — GitHub and PyPI authenticate via OIDC.
    environment: pypi

    permissions:
      id-token: write # required for OIDC / Trusted Publisher auth with PyPI
      contents: write # required to create a GitHub Release

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed for setuptools-scm to read the tag version

      - uses: astral-sh/setup-uv@v5
        with:
          python-version: "3.13"

      - name: Check version is release-ready
        run: |
          # git describe fails outright if no tag exists; --exact-match fails if HEAD is not tagged.
          if ! git describe --tags --exact-match HEAD 2>/dev/null; then
            echo ""
            echo "Error: the current commit is not exactly on a version tag."
            echo "Tag it first:  git tag v<X.Y.Z> && git push origin v<X.Y.Z>"
            exit 1
          fi
          echo "Version tag found: $(git describe --tags --exact-match HEAD)"

      - name: Build wheel and sdist
        run: uv build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: dist/*
